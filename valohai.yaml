# batman - Datum Alias Testing

- step:
    name: batman-update-chant-alias
    image: ghcr.io/astral-sh/uv:python3.11-bookworm-slim
    command: uv run batman {parameters}
    parameters:
      - name: age
        type: integer
        default: 26

# genesis - Datasets and Dataset Versions

- step:
    name: genesis-new-dataset-version
    image: ghcr.io/astral-sh/uv:python3.11-bookworm-slim
    command: uv run genesis {parameters}
    parameters:
      - name: dataset-name
        type: string
        default: verses
      - name: file-count
        type: integer
        default: 50

# mech - Execution Metadata

- step:
    name: mech-create-noise
    image: ghcr.io/astral-sh/uv:python3.11-bookworm-slim
    command: uv run mech {parameters}
    parameters:
      - name: beep-count
        type: integer
        default: 25
      - name: boop-count
        type: integer
        default: 25

- step:
    name: mech-announce-noise
    image: ghcr.io/astral-sh/uv:python3.11-bookworm-slim
    command:
      - echo {parameters}
    parameters:
      - name: message
        type: string

- pipeline:
    name: mech-beep-boop
    nodes:
      - name: create-noise-node
        step: mech-create-noise
        type: execution
      - name: announce-beeps-node
        step: mech-announce-noise
        type: task
      - name: announce-boops-node
        step: mech-announce-noise
        type: task
    edges:
      - source: create-noise-node.metadata.beeps
        target: announce-beeps-node.parameter.message
      - source: create-noise-node.metadata.boops
        target: announce-boops-node.parameter.message

# prism - Image Comparison

- step:
    name: prism-gen
    image: ghcr.io/astral-sh/uv:python3.11-bookworm-slim
    command: uv run prism
    inputs:
      - name: images

# prophet - Models and Model Versions

- step:
    name: prophet-new-model-version
    description: Create a new model version, remember to create the model before creating any versions!
    image: ghcr.io/astral-sh/uv:python3.11-bookworm-slim
    command: uv run prophet {parameters}
    parameters:
      - name: model-uri
        type: string
        default: "model://unicorns/"

# env - Environment Variables

- step:
    name: env-environmental-impact
    image: python:3.11-slim-bookworm
    command:
      - printenv
    environment-variables:
      - name: STEP_FURNITURE
        default: chair
      - name: STEP_FOOD
        default: lasagna
        optional: false

# param - Parameters

- step:
    name: param-etrized
    image: python:3.11-slim-bookworm
    command: echo {parameters}
    parameters:
      - name: subcommand
        type: string
        default: dinosaur
        pass-as: "{value}"
      - name: experiment-name
        type: string
        default: roomba_1
      - name: pipeline.model.field.inside
        type: string
        choices: ["True", "False"]
        default: "False"
        optional: True
      - name: trainer.max_iterations
        type: integer
        default: 30000

- step:
    name: param-do-not-wrap-please
    image: python:3.11-slim-bookworm
    command: echo {parameter:args}
    parameters:
      - name: args
        type: string
        default: this-should-not-be-quoted --example /thing/over-there --test False right
        pass-as: "{value}"

- step:
    name: param-splash
    image: python:3.11-slim-bookworm
    command:
      - echo {parameters}
    parameters:
      - name: identifier
        type: string
      - name: message
        type: string
      - name: age
        type: integer
      - name: constant
        type: string
        default: "THIS IS CONSTANT"

- pipeline:
    name: param-splash-them-all
    nodes:
      - name: splash-1
        step: param-splash
        type: execution
      - name: splash-2
        step: param-splash
        type: execution
      - name: splash-task
        step: param-splash
        type: task
    edges: []
    parameters:
      - name: shared-identifier
        targets:
          - splash-1.parameters.identifier
          - splash-2.parameters.identifier
          - splash-task.parameters.identifier
      - name: greeting-message
        targets: splash-1.parameters.message
      - name: welcome-message
        targets: splash-2.parameters.message
      - name: goodbye-message
        target: splash-task.parameters.message
      - name: shared-age
        targets:
          - splash-1.parameters.age
          - splash-2.parameters.age
          - splash-task.parameters.age

- pipeline:
    name: param-splash-execution-numbers
    nodes:
      - name: splash-that-number
        step: param-splash
        type: execution
    edges: []
    parameters:
      - name: shared-identifier
        targets: splash-that-number.parameters.identifier
      - name: shared-message
        targets: splash-that-number.parameters.message
      - name: shared-age
        targets: splash-that-number.parameters.age

- pipeline:
    name: param-splash-task-numbers
    nodes:
      - name: splash-that-number
        step: param-splash
        type: task
    edges: []
    parameters:
      - name: shared-identifier
        targets: splash-that-number.parameters.identifier
      - name: shared-message
        targets: splash-that-number.parameters.message
      - name: shared-age
        targets: splash-that-number.parameters.age

# novelist - Text Processing

- step:
    name: novelist
    image: python:3.11-slim-bookworm
    command:
      - ls -la /valohai/inputs/medium
      - cp /valohai/inputs/medium/*.txt /valohai/outputs/`echo $RANDOM | md5sum | head -c 20`.txt
      - echo {parameter-value:content} >> /valohai/outputs/*.txt
      - ls -la /valohai/outputs
    parameters:
      - name: content
        type: string
        default: "This is novel content."
    inputs:
      - name: medium
        default: https://valohai-public-files.s3.eu-west-1.amazonaws.com/examples/book.txt

- pipeline:
    name: novelist-chain
    nodes:
      - name: writer-1
        step: novelist
        type: execution
      - name: writer-2
        step: novelist
        type: execution
        override:
          inputs:
            - name: medium
              default: ""
      - name: writer-3
        step: novelist
        type: execution
        override:
          inputs:
            - name: medium
              default: ""
    edges:
      - [writer-1.output.*, writer-2.input.medium]
      - [writer-2.output.*, writer-3.input.medium]
    parameters:
      - name: two-and-three-content
        targets:
          - writer-2.parameters.content
          - writer-3.parameters.content

# wii - parameter widgets

- step:
    name: wii-combobox-str
    image: ghcr.io/astral-sh/uv:python3.11-bookworm-slim
    command: echo {parameters}
    parameters:
      - name: model_architecture
        type: string
        optional: false
        description: "Neural network architecture"
        default: "resnet50"
        widget:
          type: combobox
          settings:
            options:
              - resnet50
              - resnet101
              - vgg16
              - inception_v3

- step:
    name: wii-combobox-int
    image: ghcr.io/astral-sh/uv:python3.11-bookworm-slim
    command: echo {parameters}
    parameters:
      - name: batch_size
        type: integer
        default: 32
        widget:
          type: combobox
          settings:
            options:
              - 16
              - 32
              - 64
              - 128

- step:
    name: wii-sql
    image: ghcr.io/astral-sh/uv:python3.11-bookworm-slim
    command: echo {parameters}
    parameters:
      - name: where_clause
        type: string
        description: "SQL WHERE clause for filtering"
        default: "created_at > '2025-01-01'"
        widget: sql

- step:
    name: wii-dockerfile
    image: ghcr.io/astral-sh/uv:python3.11-bookworm-slim
    command: echo {parameters}
    parameters:
      - name: base_image_config
        type: string
        widget: dockerfile
        default: |
          FROM python:3.11-slim
          RUN apt-get update && apt-get install -y git
          RUN pip install --upgrade pip

- step:
    name: wii-datumalias
    image: ghcr.io/astral-sh/uv:python3.11-bookworm-slim
    command: echo {parameters}
    parameters:
      - name: training_dataset
        type: string
        description: "Dataset alias for training data"
        widget: datumalias

# random

- step:
    name: x-live-upload-for-a-while
    image: ghcr.io/astral-sh/uv:python3.11-bookworm-slim
    command:
      - |
        for i in $(seq 1 20); do
          echo base-data-${i} >> /valohai/outputs/base-${i}
          chmod 444 /valohai/outputs/base-${i}
        done;
        for i in $(seq 1 {parameter-value:count}); do
          echo data-${i} >> /valohai/outputs/my-file-${i}
          chmod 444 /valohai/outputs/my-file-${i}
          sleep 5
        done;
    parameters:
      - name: count
        type: integer
        default: 100

- step:
    name: x-mount-that-nfs-horse
    image: ghcr.io/astral-sh/uv:python3.11-bookworm-slim
    command:
      - echo "Hello, world!"
      - sleep 5
    mounts:
      - source: 128.331.31.31
        destination: /mnt/remote
        readonly: true
        type: nfs

- step:
    name: x-upload-to-custom-store
    image: ghcr.io/astral-sh/uv:python3.11-bookworm-slim
    command:
      - sleep 3
      - echo "Hello, world!" > /valohai/outputs/greeting.txt
      - sleep 3
    upload-store: "0194e072-7edd-043d-22cd-2766211bfe37"

- step:
    name: x-two-input-slots
    image: ghcr.io/astral-sh/uv:python3.11-bookworm-slim
    command:
      - |
        sleep 1
        echo -e "\nTODO:"
        cd /valohai/inputs/todo
        ls -la
        echo
        find . -maxdepth 1 -name "*.txt" -exec cat {} \; -exec echo \;
        sleep 1
        echo -e "\nDONOT:"
        cd /valohai/inputs/donot
        ls -la
        echo
        find . -maxdepth 1 -name "*.txt" -exec cat {} \; -exec echo \;
        sleep 1
        echo -e "\n\n"
        sleep 1
        cat /valohai/config/inputs.json
        sleep 3
    inputs:
      - name: todo
      - name: donot

- step:
    name: x-has-cache-volume
    image: ghcr.io/astral-sh/uv:python3.11-bookworm-slim
    command:
      - echo {parameters}
    parameters:
      - name: message
        type: string
        default: "Hello, world!"
    cache-volumes: [sir-stores-a-lot]

- step:
    name: x-has-cache-volumes-empty
    image: ghcr.io/astral-sh/uv:python3.11-bookworm-slim
    command:
      - echo {parameters}
    parameters:
      - name: message
        type: string
        default: "Hello, world!"
    cache-volumes: []

- step:
    name: x-has-cpu-min-and-mem-min-max
    image: ghcr.io/astral-sh/uv:python3.11-bookworm-slim
    command:
      - echo {parameters}
    parameters:
      - name: message
        type: string
        default: "Hello, world!"
    resources:
      cpu:
        min: 1.23
      memory:
        min: 64
        max: 128

- step:
    name: x-has-cpu-min-and-mem-min-max
    image: ghcr.io/astral-sh/uv:python3.11-bookworm-slim
    command:
      - echo {parameters}
    parameters:
      - name: message
        type: string
        default: "Hello, world!"
    resources:
      cpu:
        min: 1.23
      memory:
        min: 64
        max: 128

- step:
    name: x-has-devices-gpu
    image: ghcr.io/astral-sh/uv:python3.11-bookworm-slim
    command:
      - echo {parameters}
    parameters:
      - name: message
        type: string
        default: "Hello, world!"
    resources:
      devices:
        nvidia.com/gpu: 1

- step:
    name: x-has-devices-empty
    image: ghcr.io/astral-sh/uv:python3.11-bookworm-slim
    command:
      - echo {parameters}
    parameters:
      - name: message
        type: string
        default: "Hello, world!"
    resources:
      devices: {}

- step:
    name: x-very-descriptive
    description: |
      Run for manual [drift detection](https://ruk.si/notes/machine-learning/drift/)
    image: ghcr.io/astral-sh/uv:python3.11-bookworm-slim
    command:
      - echo {parameters}
    parameters:
      - name: message
        type: string
        default: "Hello, world!"
        description: |
          _Remember_ to [be concise](https://ruk.si/notes/academic/writing-message-form/).

- pipeline:
    name: x-descriptive-pipeline
    nodes:
      - name: greet-me
        step: x-very-descriptive
        type: task
    edges: []
    parameters:
      - name: shared-identifier
        targets: greet-me.parameters.message

- endpoint:
    name: x-greet
    image: python:3.9
    port: 8000
    server-command: python -m wsgiref.simple_serve
